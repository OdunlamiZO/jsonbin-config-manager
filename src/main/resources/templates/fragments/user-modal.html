<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="userModal">
  <div
    id="user-modal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 justify-center items-center z-50"
  >
    <div class="bg-white p-6 rounded-lg w-full max-w-md relative">
      <button
        class="absolute top-3 right-3 text-primary-base hover:text-primary-dark"
        onclick="closeUserModal()"
        type="button"
        aria-label="Close"
      >
        âœ•
      </button>

      <div class="space-y-1 mb-6">
        <h1 class="text-lg font-semibold">Add New User</h1>
        <p class="text-sm text-primary-base">
          Fill in the details to create a new user account.
        </p>
      </div>

      <form
        method="post"
        th:action="@{/user/add}"
        id="user-form"
        onsubmit="return validateUserForm()"
      >
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <div class="mb-4 space-y-1">
          <label class="block text-sm font-medium">Name</label>
          <input
            type="text"
            name="name"
            id="user-name"
            placeholder="John Doe"
            class="w-full border border-primary-base rounded-md px-3 py-2 text-sm focus:outline-none focus:border-primary-dark focus:ring-1 focus:ring-primary-dark"
          />
          <div
            id="user-name-error"
            class="hidden text-xs text-red-text mt-1"
          ></div>
        </div>

        <div class="mb-4 space-y-1">
          <label class="block text-sm font-medium">Email</label>
          <input
            type="email"
            name="email"
            id="user-email"
            placeholder="admin@example.com"
            class="w-full border border-primary-base rounded-md px-3 py-2 text-sm focus:outline-none focus:border-primary-dark focus:ring-1 focus:ring-primary-dark"
          />
          <div
            id="user-email-error"
            class="hidden text-xs text-red-text mt-1"
          ></div>
        </div>

        <div class="mb-4 space-y-1">
          <div
            th:replace="fragments/custom-select :: customSelect('user-role', 'role', 'Role', ${roleOptions}, null, false)"
          ></div>
        </div>

        <div class="mb-8 space-y-1">
          <label class="block text-sm font-medium">Password</label>
          <input
            type="password"
            name="password"
            id="user-password"
            class="w-full border border-primary-base rounded-md px-3 py-2 text-sm focus:outline-none focus:border-primary-dark focus:ring-1 focus:ring-primary-dark"
          />
          <div
            id="user-password-error"
            class="hidden text-xs text-red-text mt-1"
          ></div>
        </div>

        <div class="flex justify-end gap-3">
          <button
            type="button"
            onclick="closeUserModal()"
            class="w-28 px-4 py-2 rounded font-medium bg-red-bg text-red-text border border-red-border transition-colors duration-150 hover:bg-red-bg-hover hover:text-red-text-hover hover:border-red-border-hover"
          >
            Cancel
          </button>

          <button
            type="submit"
            class="w-28 px-4 py-2 rounded font-medium bg-primary-base text-white border border-primary-dark transition-colors duration-150 hover:bg-primary-dark hover:border-primary-dark"
          >
            Add User
          </button>
        </div>
      </form>
    </div>

    <script>
      // Validate form
      function validateUserForm() {
        let valid = true;
        // Validate name field
        const name = document.getElementById("user-name").value.trim();
        const nameError = document.getElementById("user-name-error");
        if (!name) {
          nameError.textContent = "Name is required.";
          nameError.classList.remove("hidden");
          valid = false;
        } else {
          nameError.classList.add("hidden");
        }
        // Validate email field and format
        const email = document.getElementById("user-email").value.trim();
        const emailError = document.getElementById("user-email-error");
        if (!email) {
          emailError.textContent = "Email is required.";
          emailError.classList.remove("hidden");
          valid = false;
        } else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          emailError.textContent = "Enter a valid email address.";
          emailError.classList.remove("hidden");
          valid = false;
        } else {
          emailError.classList.add("hidden");
        }
        // Only require password in add mode
        const form = document.getElementById("user-form");
        const isAddMode = form && form.action.endsWith("/user/add");
        const password = document.getElementById("user-password").value.trim();
        const passwordError = document.getElementById("user-password-error");
        if (isAddMode) {
          if (!password) {
            passwordError.textContent = "Password is required.";
            passwordError.classList.remove("hidden");
            valid = false;
          } else {
            passwordError.classList.add("hidden");
          }
        } else {
          // In edit mode, password is optional
          passwordError.classList.add("hidden");
        }
        return valid;
      }

      // Open the modal in add user mode and reset all fields
      function openUserModal() {
        const modal = document.getElementById("user-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.querySelector("h1").textContent = "Add New User";
        modal.querySelector("p.text-sm").textContent =
          "Fill in the details to create a new user account.";
        const form = document.getElementById("user-form");
        form.action = "/user/add";
        form.querySelector("button[type='submit']").textContent = "Add User";
        document.getElementById("user-name").readOnly = false;
        document.getElementById("user-email").readOnly = false;
        // Show password field in add mode
        const passwordField = document
          .getElementById("user-password")
          .closest(".mb-8");
        if (passwordField) passwordField.style.display = "";
        form.reset();
      }

      // Open the modal in edit user mode and prefill fields
      function openEditUserModal(btn) {
        const modal = document.getElementById("user-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.querySelector("h1").textContent = "Edit User";
        modal.querySelector("p.text-sm").textContent =
          "Update the user's role or name. Email cannot be changed.";
        const form = document.getElementById("user-form");
        form.action = "/user/" + btn.getAttribute("data-user-id") + "/edit";
        form.querySelector("button[type='submit']").textContent = "Save";
        // Prefill name and email fields
        const nameInput = document.getElementById("user-name");
        const emailInput = document.getElementById("user-email");
        nameInput.value = btn.getAttribute("data-user-name") || "";
        emailInput.value = btn.getAttribute("data-user-email") || "";
        emailInput.readOnly = true;
        // Hide password field in edit mode
        const passwordField = document
          .getElementById("user-password")
          .closest(".mb-8");
        if (passwordField) passwordField.style.display = "none";
        // Set role select to current value
        const role = btn.getAttribute("data-user-role");
        const roleInput = document.getElementById("user-role-hidden-input");
        const roleButton = document.getElementById("user-role-button");
        if (roleInput) roleInput.value = role;
        if (roleButton) {
          // Simulate click on correct dropdown option to update label and value
          const dropdown = document.getElementById("user-role-dropdown");
          if (dropdown) {
            const options = dropdown.querySelectorAll("li[data-value]");
            options.forEach(function (option) {
              if (option.getAttribute("data-value") === role) {
                option.click();
              }
            });
          }
        }
        // Enable role select
        roleButton && roleButton.classList.remove("disabled");
      }

      // Close the user modal and reset to add mode
      function closeUserModal() {
        const modal = document.getElementById("user-modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modal.querySelector("h1").textContent = "Add New User";
        modal.querySelector("p.text-sm").textContent =
          "Fill in the details to create a new user account.";
        const form = document.getElementById("user-form");
        form.action = "/user/add";
        form.querySelector("button[type='submit']").textContent = "Add User";
        document.getElementById("user-name").readOnly = false;
        document.getElementById("user-email").readOnly = false;
        // Show password field in add mode
        const passwordField = document
          .getElementById("user-password")
          .closest(".mb-8");
        if (passwordField) passwordField.style.display = "";
        form.reset();
      }
    </script>
  </div>
</html>
