<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="userModal">
  <div
    id="user-modal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 justify-center items-center z-50"
  >
    <div class="bg-white p-6 rounded-lg w-full max-w-md relative">
      <button
        class="absolute top-3 right-3 text-primary-base hover:text-primary-dark"
        onclick="closeUserModal()"
        type="button"
        aria-label="Close"
      >
        ✕
      </button>

      <div class="space-y-1 mb-6">
        <h1 class="text-lg font-semibold">Add New User</h1>
        <p class="text-sm text-primary-base">
          Fill in the details to create a new user account.
        </p>
      </div>

      <form
        method="post"
        th:action="@{/user/add}"
        id="user-form"
        onsubmit="return validateUserForm();"
      >
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <div class="mb-4 space-y-1">
          <label class="block text-sm font-medium">Name</label>

          <input
            type="text"
            name="name"
            id="user-name"
            placeholder="John Doe"
            class="w-full border border-primary-base rounded-md px-3 py-2 text-sm focus:outline-none focus:border-primary-dark focus:ring-1 focus:ring-primary-dark"
          />

          <div
            id="user-name-error"
            class="hidden text-xs text-red-text mt-1"
          ></div>
        </div>

        <div class="mb-4 space-y-1">
          <label class="block text-sm font-medium">Email</label>

          <input
            type="email"
            name="email"
            id="user-email"
            placeholder="admin@example.com"
            class="w-full border border-primary-base rounded-md px-3 py-2 text-sm focus:outline-none focus:border-primary-dark focus:ring-1 focus:ring-primary-dark"
          />
          <div
            id="user-email-error"
            class="hidden text-xs text-red-text mt-1"
          ></div>
        </div>

        <div class="mb-4 space-y-1">
          <div
            th:replace="fragments/custom-select :: customSelect('user-role', 'role', 'Role', ${roleOptions}, null, false)"
          ></div>
        </div>

        <div class="mb-8 space-y-1" th:if="${!smtpEnabled}">
          <label class="block text-sm font-medium">Password</label>

          <div class="relative">
            <input
              type="password"
              name="password"
              id="user-password"
              readonly
              class="w-full border border-primary-base rounded-md px-3 py-2 pr-40 text-sm text-primary-dark bg-primary-light focus:outline-none focus:border-primary-dark focus:ring-1 focus:ring-primary-dark"
            />

            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
              <button
                type="button"
                class="px-2 py-1 text-xs rounded border border-primary-mid text-primary-dark bg-primary-light hover:bg-primary-base hover:text-white transition-colors"
                onclick="generateUserPassword()"
              >
                Generate
              </button>

              <button
                id="copy-password-btn"
                type="button"
                class="px-2 py-1 text-xs rounded border border-primary-mid text-primary-dark bg-primary-light hover:bg-primary-base hover:text-white transition-colors"
                onclick="copyUserPassword()"
              >
                Copy
              </button>
            </div>
          </div>

          <div
            id="user-password-error"
            class="hidden text-xs text-red-text mt-1"
          ></div>
        </div>

        <div class="flex justify-end gap-3">
          <button
            type="button"
            onclick="closeUserModal()"
            class="w-28 px-4 py-2 rounded font-medium bg-red-bg text-red-text border border-red-border transition-colors duration-150 hover:bg-red-bg-hover hover:text-red-text-hover hover:border-red-border-hover"
          >
            Cancel
          </button>

          <button
            type="submit"
            class="w-28 px-4 py-2 rounded font-medium bg-primary-base text-white border border-primary-dark transition-colors duration-150 hover:bg-primary-dark hover:border-primary-dark"
          >
            Add User
          </button>
        </div>
      </form>
    </div>

    <script>
      function validateUserForm() {
        let valid = true;

        // Validate name field
        const name = document.getElementById('user-name').value.trim();
        const nameError = document.getElementById('user-name-error');

        if (!name) {
          nameError.textContent = 'Name is required.';
          nameError.classList.remove('hidden');
          valid = false;
        } else {
          nameError.classList.add('hidden');
        }

        // Validate email field and format
        const email = document.getElementById('user-email').value.trim();
        const emailError = document.getElementById('user-email-error');

        if (!email) {
          emailError.textContent = 'Email is required.';
          emailError.classList.remove('hidden');
          valid = false;
        } else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          emailError.textContent = 'Enter a valid email address.';
          emailError.classList.remove('hidden');
          valid = false;
        } else {
          emailError.classList.add('hidden');
        }

        // Only require password in add mode and smtp disabled
        const form = document.getElementById('user-form');
        const isAddMode = form && form.action.endsWith('/user/add');

        const passwordInput = document.getElementById('user-password');
        const passwordError = document.getElementById('user-password-error');

        if (isAddMode && passwordInput) {
          const password = passwordInput.value.trim();
          if (!password) {
            passwordError.textContent = 'Password is required.';
            passwordError.classList.remove('hidden');
            valid = false;
          } else {
            passwordError.classList.add('hidden');
          }
        } else {
          passwordError && passwordError.classList.add('hidden');
        }

        return valid;
      }

      function setCopyButtonVisible(visible) {
        const btn = document.getElementById('copy-password-btn');
        if (btn) btn.style.display = visible ? '' : 'none';
      }

      // Generate a strong password and fill the field
      function generateUserPassword() {
        const input = document.getElementById('user-password');
        if (!input) return;

        const length = 14;
        const chars =
          'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{};:,.?';
        let pwd = '';
        for (let i = 0; i < length; i++) {
          pwd += chars[Math.floor(Math.random() * chars.length)];
        }

        input.value = pwd;
        input.type = 'text';
        input.focus();
        input.select();

        setCopyButtonVisible(true);

        const error = document.getElementById('user-password-error');
        error && error.classList.add('hidden');
      }

      function copyUserPassword() {
        const input = document.getElementById('user-password');
        const btn = document.getElementById('copy-password-btn');
        if (!input || !input.value || !btn) return;

        navigator.clipboard.writeText(input.value).then(() => {
          const original = btn.textContent;

          btn.textContent = 'Copied ✓';
          btn.classList.add('bg-primary-base', 'text-white');

          // Hide password after copy
          input.type = 'password';

          setTimeout(() => {
            btn.textContent = original;
            btn.classList.remove('bg-primary-base', 'text-white');

            // Hide copy button after successful copy
            setCopyButtonVisible(false);
          }, 800);
        });
      }

      // Open the modal in add user mode and reset all fields
      function openUserModal() {
        const modal = document.getElementById('user-modal');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        modal.querySelector('h1').textContent = 'Add New User';
        modal.querySelector('p.text-sm').textContent =
          'Fill in the details to create a new user account.';

        const form = document.getElementById('user-form');
        form.action = '/user/add';
        form.querySelector("button[type='submit']").textContent = 'Add User';

        // Show password field in add mode
        const passwordInput = document.getElementById('user-password');
        if (passwordInput) {
          const passwordField = passwordInput.closest('.mb-8');
          passwordField && (passwordField.style.display = '');
        }

        form.reset();
        // Auto-generate password only if field exists
        if (document.getElementById('user-password')) {
          generateUserPassword();
        }
      }

      // Open the modal in edit user mode and prefill fields
      function openEditUserModal(btn) {
        const modal = document.getElementById('user-modal');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        modal.querySelector('h1').textContent = 'Edit User';
        modal.querySelector('p.text-sm').textContent =
          "Update the user's role or name. Email cannot be changed.";

        const form = document.getElementById('user-form');
        form.action = '/user/' + btn.getAttribute('data-user-id') + '/edit';
        form.querySelector("button[type='submit']").textContent = 'Save';

        // Prefill name and email fields
        const nameInput = document.getElementById('user-name');
        const emailInput = document.getElementById('user-email');
        nameInput.value = btn.getAttribute('data-user-name') || '';
        emailInput.value = btn.getAttribute('data-user-email') || '';

        // Make email read-only in edit mode
        emailInput.readOnly = true;

        // Hide password field in edit mode
        const passwordInput = document.getElementById('user-password');
        if (passwordInput) {
          const passwordField = passwordInput.closest('.mb-8');
          passwordField && (passwordField.style.display = 'none');
        }

        // Set role select to current value
        const role = btn.getAttribute('data-user-role');
        const roleInput = document.getElementById('user-role-hidden-input');
        const roleButton = document.getElementById('user-role-button');
        if (roleInput) roleInput.value = role;
        if (roleButton) {
          // Simulate click on correct dropdown option to update label and value
          const dropdown = document.getElementById('user-role-dropdown');
          if (dropdown) {
            const options = dropdown.querySelectorAll('li[data-value]');
            options.forEach(function (option) {
              if (option.getAttribute('data-value') === role) {
                option.click();
              }
            });
          }
        }
        // Enable role select
        roleButton && roleButton.classList.remove('disabled');
      }

      // Close the user modal and reset to add mode
      function closeUserModal() {
        const modal = document.getElementById('user-modal');

        modal.classList.add('hidden');
        modal.classList.remove('flex');

        modal.querySelector('h1').textContent = 'Add New User';
        modal.querySelector('p.text-sm').textContent =
          'Fill in the details to create a new user account.';

        const form = document.getElementById('user-form');
        form.action = '/user/add';
        form.querySelector("button[type='submit']").textContent = 'Add User';

        // Enable email field
        document.getElementById('user-email').readOnly = false;

        // Show password field in add mode
        const passwordInput = document.getElementById('user-password');
        if (passwordInput) {
          const passwordField = passwordInput.closest('.mb-8');
          passwordField && (passwordField.style.display = '');
        }

        form.reset();
      }
    </script>
  </div>
</html>
