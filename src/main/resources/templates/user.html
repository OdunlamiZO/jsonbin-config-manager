<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>JSONBin Config Manager - User Management</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel="stylesheet" th:href="@{/css/application.css}" />

    <div
      th:replace="fragments/relative-time-script :: relativeTimeScript"
    ></div>
  </head>

  <body class="poppins-regular">
    <div class="jsonbin-page">
      <div th:replace="fragments/header :: header"></div>

      <div class="flex-1 px-24 py-8 bg-primary-light space-y-4">
        <div class="flex items-center justify-between">
          <span class="flex flex-col gap-1">
            <span class="text-lg font-semibold">User Management</span>
            <span class="text-xs text-primary-base"
              >Manage team members, roles, and access permissions.</span
            >
          </span>

          <button
            class="flex items-center gap-2 rounded-lg bg-primary-dark px-4 py-2 text-sm font-semibold text-white transition-opacity hover:bg-primary-base disabled:opacity-50 disabled:cursor-not-allowed"
            onclick="openUserModal()"
            th:disabled="${!#authorization.expression('hasAnyRole(''ADMIN'',''SUPER_ADMIN'')')}"
          >
            <span
              class="material-symbols-outlined text-white text-[18px] -translate-x-1"
              >add</span
            >
            New User
          </button>
        </div>

        <div class="border border-primary-mid bg-white rounded-lg pt-16">
          <table class="w-full border-collapse">
            <thead class="bg-primary-light border-y border-primary-mid">
              <tr>
                <th
                  class="px-5 py-3 text-left text-sm font-semibold text-primary-dark"
                >
                  User
                </th>
                <th
                  class="px-5 py-3 text-left text-sm font-semibold text-primary-dark"
                >
                  Role
                </th>
                <th
                  class="px-5 py-3 text-left text-sm font-semibold text-primary-dark"
                >
                  Last Active
                </th>
                <th
                  class="px-5 py-3 text-center text-sm font-semibold text-primary-dark w-32"
                  style="text-align: right"
                >
                  Action
                </th>
              </tr>
            </thead>

            <tbody>
              <tr
                th:each="user : ${users}"
                class="border-t border-primary-mid hover:bg-primary-lighter transition-colors"
              >
                <td class="px-5 py-3 text-primary-dark font-medium">
                  <div class="flex items-center gap-3">
                    <span
                      class="flex items-center justify-center h-9 w-9 rounded-full bg-primary-light text-primary-dark font-semibold text-base border border-primary-mid"
                    >
                      <span
                        th:text="${#strings.substring(user.name, 0, 1).toUpperCase()}"
                      ></span>
                    </span>
                    <div class="flex flex-col">
                      <span
                        class="text-sm font-semibold text-primary-dark"
                        th:text="${user.name}"
                      ></span>
                      <span
                        class="text-xs text-primary-base"
                        th:text="${user.email}"
                      ></span>
                    </div>
                  </div>
                </td>

                <td class="px-5 py-3">
                  <span
                    th:classappend="${user.role.name() == 'SUPER_ADMIN' ? 'bg-purple-200 text-purple-800 border-purple-400' : user.role.name() == 'ADMIN' ? 'bg-green-bg text-green-text border-green-border' : user.role.name() == 'EDITOR' ? 'bg-blue-bg text-blue-text border-blue-border' : user.role.name() == 'VIEWER' ? 'bg-primary-light text-primary-base border-primary-mid' : 'bg-gray-200 text-gray-700 border-gray-300'}"
                    class="inline-block px-2 py-0.5 rounded text-xs font-semibold border align-middle"
                    th:text="${user.role.name() == 'SUPER_ADMIN' ? 'Super Admin' : user.role.name() == 'ADMIN' ? 'Admin' : user.role.name() == 'EDITOR' ? 'Editor' : user.role.name() == 'VIEWER' ? 'Viewer' : 'N/A'}"
                  ></span>
                </td>

                <td class="px-5 py-3 text-primary-base">
                  <span
                    class="italic text-primary-mid relative-date"
                    th:attr="data-created-at=${user.lastSeen}"
                    th:text="${user.lastSeen}"
                  ></span>
                </td>

                <td class="px-5 py-3 table-cell align-middle">
                  <div class="relative flex items-center justify-end">
                    <th:block
                      th:if="${user.role.name() != 'SUPER_ADMIN' and user.id != principal?.id}"
                    >
                      <button
                        type="button"
                        class="rounded-full p-2 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="toggleOptionsMenu(this)"
                        th:disabled="${user.role.name() == 'ADMIN' ? !#authorization.expression('hasRole(''SUPER_ADMIN'')') : !#authorization.expression('hasAnyRole(''ADMIN'',''SUPER_ADMIN'')') }"
                      >
                        <span
                          class="material-symbols-outlined text-primary-dark"
                          >more_vert</span
                        >
                      </button>

                      <div
                        class="hidden absolute top-0 right-10 z-50 min-w-[120px] bg-white border border-primary-mid rounded shadow-lg flex-col py-1"
                        data-options-menu
                      >
                        <button
                          type="button"
                          class="w-full text-left px-4 py-2 text-xs text-primary-dark hover:bg-primary-light hover:text-primary-base disabled:opacity-50 disabled:cursor-not-allowed"
                          th:disabled="${user.role.name() == 'ADMIN' ? !#authorization.expression('hasRole(''SUPER_ADMIN'')') : !#authorization.expression('hasAnyRole(''ADMIN'',''SUPER_ADMIN'')') }"
                          onclick="openEditUserModal(this)"
                          th:attr="data-user-id=${user.id},data-user-name=${user.name},data-user-email=${user.email},data-user-role=${user.role.name()}"
                        >
                          Edit
                        </button>

                        <button
                          type="button"
                          class="w-full text-left px-4 py-2 text-xs text-red-text hover:bg-red-bg hover:text-white disabled:opacity-50 disabled:cursor-not-allowed"
                          th:attr="data-action-url=@{'/user/' + ${user.id} + '/delete'},data-username=${user.name}"
                          onclick="openDeleteConfirmModal({
                            actionUrl: this.dataset.actionUrl,
                            title: 'Delete User',
                            message: 'Are you sure you want to delete user <span class=\'font-semibold\'>' + this.dataset.username + '</span>? This action cannot be undone.'
                          })"
                          th:disabled="${user.role.name() == 'ADMIN' ? !#authorization.expression('hasRole(''SUPER_ADMIN'')') : !#authorization.expression('hasAnyRole(''ADMIN'',''SUPER_ADMIN'')') }"
                        >
                          Delete
                        </button>
                      </div>
                    </th:block>
                  </div>
                </td>

                <script>
                  // Toggle the visibility of the options menu for a user row
                  function toggleOptionsMenu(btn) {
                    // Hide all open menus first
                    document
                      .querySelectorAll("[data-options-menu]")
                      .forEach((menu) => menu.classList.add("hidden"));
                    // Show or hide the menu for this button
                    const menu = btn.parentElement.querySelector(
                      "[data-options-menu]"
                    );
                    if (menu) menu.classList.toggle("hidden");
                  }
                  // Hide any open options menu when clicking outside
                  document.addEventListener("click", function (event) {
                    const isOptionsBtn = event.target.closest(
                      'button[onclick="toggleOptionsMenu(this)"]'
                    );
                    const isMenu = event.target.closest("[data-options-menu]");
                    if (!isOptionsBtn && !isMenu) {
                      document
                        .querySelectorAll("[data-options-menu]")
                        .forEach((menu) => menu.classList.add("hidden"));
                    }
                  });
                </script>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div
        th:replace="fragments/delete-confirm-modal :: deleteConfirmModal"
      ></div>

      <div th:replace="fragments/user-modal :: userModal"></div>

      <div th:replace="fragments/footer :: footer"></div>
    </div>
  </body>
</html>
